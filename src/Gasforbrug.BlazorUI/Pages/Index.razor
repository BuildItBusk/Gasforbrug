@page "/"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using System.ComponentModel.DataAnnotations
@inject ProtectedLocalStorage BrowserStorage

<PageTitle>Mit gasforbrug</PageTitle>

<h1>Mit gasforbrug</h1>
<h2>Aflæs</h2>
<Validations @ref="validations" Mode="ValidationMode.Manual" Model="@reading">
    <p>
        <label for="Date">
            Dato:<br />
            <Validation>
                <Field>
                    <DateEdit @bind-Date="reading.Date">
                        <Feedback>
                            <ValidationError />
                        </Feedback>
                    </DateEdit>
                </Field>
            </Validation>
        </label>
    </p>
    <p>
        <label for="reading">
            Aflæst værdi: <br />
            <Validation>
                <Field>
                    <NumericEdit TValue="decimal" @bind-Value="reading.Value">
                        <Feedback>
                            <ValidationError />
                        </Feedback>
                    </NumericEdit>
                </Field>
            </Validation>
        </label>
    </p>
</Validations>

    <Button Color="Color.Primary" Type="ButtonType.Submit" Clicked="@AddReading" id="add-reading">Tilføj aflæsning</Button>

<h2 class="mt-5">Tidligere aflæst</h2>

<Modal @ref="modalRef">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Slet aflæsning</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <p>
                Er du sikker på du vil slette denne aflæsning? Det er ikke muligt at gendanne den efterfølgende.
            </p>           
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="@HideModal">Fortryd</Button>
            <Button Color="Color.Primary" Clicked="@DeleteReading">Slet</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<div class="container m-lg-5">
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Dato</th>
                <th scope="col" class="text-end">m<sup>3</sup></th>
                <th></th>
            </tr>
        </thead>
        @foreach(var item in allReadings) 
        {
        <tr>
            <td class="align-middle">@item.Date.ToString("d. MMM")</td>
            <td class="text-end align-middle">@item.Value.ToString("N3")</td>
            <td><Icon Name="IconName.Delete" Clicked="() => ShowModal(item)" /></td>
        </tr>
        }
    </table>
</div>

@code {
    private Reading reading = new() { Date = DateTime.Now };
    private List<Reading> allReadings = new();
    private Modal? modalRef;
    private Reading? markedForDelete = null; 

    private Task ShowModal(Reading? reading)
    {
        markedForDelete = reading;
        return modalRef?.Show() ?? Task.CompletedTask;
    }

    private Task HideModal()
    {
        markedForDelete = null;
        return modalRef?.Hide() ?? Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        var fromStorage = await BrowserStorage.GetAsync<List<Reading>>("readings");
        var result  = fromStorage.Success ? fromStorage.Value : new List<Reading>();

        if (result is not null)
            allReadings = result;

        StateHasChanged();
    }


    Validations? validations = new();        
    private async Task AddReading()
    {
        if (validations is null)
            return;

        if (await validations.ValidateAll())
        {
            allReadings.Add(reading);
            await SaveToBrowserStorage();
            reading = new() { Date = DateTime.Now };
        }
    }
        

    private async Task DeleteReading()
    {
        if (markedForDelete is not null)
            allReadings.Remove(markedForDelete);

        await SaveToBrowserStorage();

        modalRef?.Hide();
    }

    private async Task SaveToBrowserStorage()  => await BrowserStorage.SetAsync("readings", allReadings);

    public sealed class Reading
    {
        public Guid Id { get; set; } = Guid.NewGuid();

        [Required]
        public DateTime Date { get; set; }

        [Required]
        [Range(1, int.MaxValue, ErrorMessage = "Skal være et positivt tal.")]
        public decimal Value { get; set; }
    }
}